# Руководство по миграциям базы данных

## Обзор

Для безопасного управления изменениями схемы базы данных в проекте MyUnion Dashboard создана система автоматических миграций, которая предотвращает потерю данных при обновлении структуры БД.

## Доступные команды

### 1. Безопасная миграция (рекомендуется)
```bash
npm run db:migrate
```

**Что делает:**
- Создает резервную копию всех данных
- Пытается применить изменения без потери данных
- Если это невозможно, автоматически выполняет сброс с восстановлением данных
- Работает только в development окружении

### 2. Обычная миграция
```bash
npm run db:push
```

**Что делает:**
- Применяет изменения схемы к базе данных
- Может завершиться ошибкой, если изменения несовместимы с существующими данными

### 3. Принудительный сброс (только для разработки)
```bash
npm run db:reset
```

**Что делает:**
- Полностью удаляет все данные и пересоздает схему
- ⚠️ **ОПАСНО** - удаляет все данные безвозвратно
- Используйте только в development окружении

## Как добавить новые сущности

### Шаг 1: Обновите схему Prisma
Отредактируйте файл `prisma/schema.prisma`:

```prisma
model NewEntity {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("new_entities")
}
```

### Шаг 2: Выполните миграцию
```bash
npm run db:migrate
```

Система автоматически:
- Создаст резервную копию данных
- Применит изменения схемы
- Восстановит данные (если потребуется сброс)

### Шаг 3: Обновите Prisma Client
```bash
npm run db:generate
```

## Безопасность

### Development окружение
- Автоматические резервные копии
- Безопасный сброс с восстановлением данных
- Полная автоматизация процесса

### Production окружение
- Автоматический сброс **запрещен**
- Требуется ручное разрешение конфликтов
- Рекомендуется использовать официальные Prisma Migrations

## Структура файлов

```
scripts/
├── migrate.js          # Основной скрипт миграций
└── ...

prisma/
├── schema.prisma       # Схема базы данных
└── ...
```

## Примеры использования

### Добавление нового поля
```prisma
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  // Новое поле
  phone    String? // Опциональное поле безопасно
  isActive Boolean @default(true) // Поле с default безопасно
}
```

### Добавление новой модели
```prisma
model Post {
  id        String   @id @default(cuid())
  title     String
  content   String
  authorId  String
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  
  @@map("posts")
}
```

### Изменение типа поля
```prisma
model User {
  // Безопасно: String -> String?
  phone String?
  
  // Опасно: String -> Int (требует сброса)
  age Int
}
```

## Устранение неполадок

### Ошибка "Argument X is missing"
Это означает, что в схеме есть обязательные поля, которых нет в коде. Решения:
1. Сделайте поле опциональным: `field String?`
2. Добавьте значение по умолчанию: `field String @default("")`
3. Выполните сброс: `npm run db:reset`

### Ошибка "Cannot reset production database"
Система защищает production от случайного сброса. Для production используйте:
1. Официальные Prisma Migrations
2. Ручное разрешение конфликтов
3. Создание миграционных скриптов

### Кэширование Prisma Client
После изменений схемы перезапустите dev сервер:
```bash
# Остановите сервер (Ctrl+C)
npm run dev
```

## Лучшие практики

1. **Всегда используйте `npm run db:migrate`** для изменений схемы
2. **Делайте поля опциональными** при добавлении новых полей
3. **Используйте значения по умолчанию** для новых обязательных полей
4. **Тестируйте изменения** в development перед production
5. **Создавайте резервные копии** перед критическими изменениями

## Поддержка

При возникновении проблем:
1. Проверьте логи в консоли
2. Убедитесь, что используете development окружение
3. Перезапустите dev сервер после изменений схемы
4. Обратитесь к документации Prisma: https://www.prisma.io/docs
